#!/bin/bash

# Author: Joseph Astier

# Reprocessor testing

# Reprocess DialogAgent metadata and compare the output with
# an expected file

inputdir="scripts/test_scripts/reprocessor_agent_testing/input"
outputdir="~scripts/test_scripts/reprocessor_agent_testing/output"

# pretty-format JSON that should resemble the reprocessed file
expected_json="$outputdir/reprocessor_test_expected.json"

# compact JSON read from the Message Bus
reprocessed_metadata="$outputdir/reprocessor_test.metadata"

# pretty-format JSON converted from reprocessed_metadata
reprocessed_json="$outputdir/reprocessor_test.json"

echo ""
echo ""
echo "REPROCESSOR TESTING: "

# delete prior generated files
rm -f *expected*.*

# Run the reprocessor on the target files
cd ~/tomcat-text
sbt "runMain org.clulab.asist.apps.RunDialogAgent reprocess $inputdir $outputdir"
cd ..


if [ -s $reprocessed_metadata ]
    then
        # pretty-print the last line of the temp file
        tail -1 $reprocessed_metadata | jq > $reprocessed_json
        # Only the timestamps should differ
        echo "Diffing expected and reprocessed files:"
        diff $expected_json $reprocessed_json
    else
        echo "No reprocessed file was found."
fi

exit 0
